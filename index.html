<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda di Allenamento</title>
    <style>
        /* [Tutto il CSS precedente rimane invariato] */
    </style>
</head>
<body>
    <!-- [Tutto il body HTML precedente rimane invariato] -->

    <script>
        // Wrapper per gestire localStorage in modo sicuro
        const StorageManager = {
            isSupported: function() {
                try {
                    return 'localStorage' in window && window['localStorage'] !== null;
                } catch (e) {
                    return false;
                }
            },
            
            saveProgress: function(progressData) {
                if (!this.isSupported()) {
                    console.warn('localStorage non supportato');
                    return;
                }
                
                try {
                    localStorage.setItem('workoutProgress', JSON.stringify(progressData));
                    localStorage.setItem('lastProgressTime', Date.now().toString());
                } catch (e) {
                    console.error('Errore nel salvataggio:', e);
                }
            },
            
            loadProgress: function() {
                if (!this.isSupported()) {
                    console.warn('localStorage non supportato');
                    return null;
                }
                
                try {
                    const progressData = localStorage.getItem('workoutProgress');
                    return progressData ? JSON.parse(progressData) : null;
                } catch (e) {
                    console.error('Errore nel caricamento:', e);
                    return null;
                }
            }
        };

        // Suono di allarme
        function playAlarm() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRhQCAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhEAIAAPD/8P/w//D/8P/w//D/');
                audio.play().catch(e => console.warn('Errore nella riproduzione audio:', e));
            } catch (e) {
                console.warn('Impossibile riprodurre l\'audio:', e);
            }
        }

        function createSeriesTracker(exerciseCard, maxSeries) {
            const exerciseType = getExerciseType(exerciseCard);
            const recoveryTime = getRecoveryTime(exerciseType);
            
            const counterDiv = document.createElement('div');
            counterDiv.className = 'series-counter';
            
            const exerciseTypeDiv = document.createElement('div');
            exerciseTypeDiv.className = 'exercise-type';
            exerciseTypeDiv.textContent = `Recupero: ${recoveryTime/60} minuti`;
            
            const counterDisplay = document.createElement('div');
            counterDisplay.className = 'counter-display';
            counterDisplay.textContent = 'Serie: 0/' + maxSeries;
            
            const timerDisplay = document.createElement('div');
            timerDisplay.className = 'timer-display';
            timerDisplay.style.display = 'none';
            
            const timerControls = document.createElement('div');
            timerControls.className = 'timer-controls';
            
            const addButton = document.createElement('button');
            addButton.textContent = '+ Serie';
            
            const resetButton = document.createElement('button');
            resetButton.textContent = 'Reset';
            resetButton.className = 'reset-button';
            
            let currentSeries = 0;
            let timerInterval;
            let isRecoveryActive = false;
            
            function saveProgress() {
                const progressData = {
                    exercise: exerciseCard.querySelector('h3').textContent,
                    currentSeries: currentSeries,
                    maxSeries: maxSeries
                };
                
                StorageManager.saveProgress([progressData]);
            }
            
            function startRecoveryTimer(duration) {
                if (isRecoveryActive) {
                    clearInterval(timerInterval);
                }
                
                let timeLeft = duration;
                timerDisplay.style.display = 'block';
                timerDisplay.classList.add('active-timer');
                isRecoveryActive = true;
                
                timerInterval = setInterval(() => {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerDisplay.textContent = `Recupero: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timeLeft === 0) {
                        clearInterval(timerInterval);
                        timerDisplay.textContent = 'Recupero completato!';
                        timerDisplay.classList.remove('active-timer');
                        isRecoveryActive = false;
                        playAlarm();
                        setTimeout(() => {
                            timerDisplay.style.display = 'none';
                        }, 3000);
                    }
                    timeLeft--;
                }, 1000);
            }
            
            addButton.addEventListener('click', () => {
                if (currentSeries < maxSeries) {
                    currentSeries++;
                    counterDisplay.textContent = `Serie: ${currentSeries}/${maxSeries}`;
                    
                    if (currentSeries < maxSeries) {
                        startRecoveryTimer(recoveryTime);
                    } else if (currentSeries === maxSeries) {
                        startRecoveryTimer(recoveryTime * 2);
                    }
                    
                    saveProgress();
                }
                
                if (currentSeries === maxSeries) {
                    addButton.disabled = true;
                }
            });
            
            resetButton.addEventListener('click', () => {
                currentSeries = 0;
                counterDisplay.textContent = `Serie: ${currentSeries}/${maxSeries}`;
                addButton.disabled = false;
                timerDisplay.style.display = 'none';
                timerDisplay.classList.remove('active-timer');
                if (timerInterval) clearInterval(timerInterval);
                isRecoveryActive = false;
                saveProgress();
            });
            
            counterDiv.appendChild(exerciseTypeDiv);
            counterDiv.appendChild(counterDisplay);
            counterDiv.appendChild(timerDisplay);
            counterDiv.appendChild(timerControls);
            counterDiv.appendChild(addButton);
            counterDiv.appendChild(resetButton);
            
            exerciseCard.appendChild(counterDiv);
            
            // Carica il progresso salvato se presente
            const savedProgress = StorageManager.loadProgress();
            if (savedProgress) {
                const exerciseProgress = savedProgress.find(p => p.exercise === exerciseCard.querySelector('h3').textContent);
                if (exerciseProgress) {
                    currentSeries = exerciseProgress.currentSeries;
                    counterDisplay.textContent = `Serie: ${currentSeries}/${maxSeries}`;
                    
                    if (currentSeries >= maxSeries) {
                        addButton.disabled = true;
                    }
                }
            }
        }
        
        function getExerciseType(exerciseCard) {
            const title = exerciseCard.closest('.exercises-grid')?.previousElementSibling?.textContent.toUpperCase() || '';
            if (title.includes('PETTO') || title.includes('GAMBE') || title.includes('SPALLE') || title.includes('DORSO')) {
                return 'large';
            } else if (title.includes('TRICIPITI') || title.includes('BICIPITI')) {
                return 'small';
            }
            return 'large';
        }
        
        function getRecoveryTime(exerciseType) {
            return exerciseType === 'large' ? 90 : 60;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const exerciseCards = document.querySelectorAll('.exercise-card');
            exerciseCards.forEach(card => {
                const seriesText = card.querySelector('p')?.textContent;
                if (seriesText) {
                    const maxSeries = parseInt(seriesText);
                    if (!isNaN(maxSeries)) {
                        createSeriesTracker(card, maxSeries);
                    }
                }
            });
        });
    </script>
</body>
</html>
