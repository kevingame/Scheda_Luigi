<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda di Allenamento</title>
    <!-- [Previous CSS remains the same] -->
    <style>
        /* Previous styles remain unchanged */
    </style>
</head>
<body>
    <!-- [Previous HTML body remains the same] -->

    <script>
        // Local Storage Key
        const STORAGE_KEY = 'workoutTrackerState';
        
        // Subtle beep sound for recovery end
        function playRecoverySound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 note
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime); // Low volume

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5); // Short beep
            } catch (error) {
                console.error('Could not play sound:', error);
            }
        }

        function createSeriesTracker(exerciseCard, maxSeries) {
            const exerciseType = getExerciseType(exerciseCard);
            const recoveryTime = getRecoveryTime(exerciseType);
            const isAbWorkout = exerciseCard.querySelector('h3')?.textContent.includes('ADDOMINALI');
            
            // Create unique identifier for this exercise
            const exerciseId = exerciseCard.querySelector('h3').textContent.replace(/\s+/g, '-').toLowerCase();
            
            // Retrieve saved state
            const savedState = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const exerciseState = savedState[exerciseId] || {};

            const counterDiv = document.createElement('div');
            counterDiv.className = 'series-counter';
            
            const exerciseTypeDiv = document.createElement('div');
            exerciseTypeDiv.className = 'exercise-type';
            exerciseTypeDiv.textContent = `Recupero: ${recoveryTime/60} minuti`;
            
            const counterDisplay = document.createElement('div');
            counterDisplay.className = 'counter-display';
            
            const timerDisplay = document.createElement('div');
            timerDisplay.className = 'timer-display';
            timerDisplay.style.display = 'none';
            
            const timerControls = document.createElement('div');
            timerControls.className = 'timer-controls';
            
            const addButton = document.createElement('button');
            addButton.textContent = '+ Serie';
            
            const resetButton = document.createElement('button');
            resetButton.textContent = 'Reset';
            resetButton.className = 'reset-button';
            
            let currentSeries = exerciseState.currentSeries || 0;
            let timerInterval;
            let workoutTimer;
            let isRecoveryActive = false;
            
            // Update display with saved state
            counterDisplay.textContent = `Serie: ${currentSeries}/${maxSeries}`;
            
            // Restore recovery timer if it was active
            if (exerciseState.recoveryEndTime) {
                const recoveryRemaining = Math.max(0, Math.ceil((exerciseState.recoveryEndTime - Date.now()) / 1000));
                if (recoveryRemaining > 0) {
                    startRecoveryTimer(recoveryRemaining);
                }
            }
            
            function saveState() {
                const savedState = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                savedState[exerciseId] = {
                    currentSeries: currentSeries,
                    recoveryEndTime: isRecoveryActive ? (Date.now() + (timeLeft * 1000)) : null
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(savedState));
            }
            
            function startRecoveryTimer(duration) {
                if (isRecoveryActive) {
                    clearInterval(timerInterval);
                }
                
                let timeLeft = duration;
                timerDisplay.style.display = 'block';
                timerDisplay.classList.add('active-timer');
                isRecoveryActive = true;
                
                timerInterval = setInterval(() => {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerDisplay.textContent = `Recupero: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    saveState(); // Save state every second
                    
                    if (timeLeft === 0) {
                        clearInterval(timerInterval);
                        timerDisplay.textContent = 'Recupero completato!';
                        timerDisplay.classList.remove('active-timer');
                        isRecoveryActive = false;
                        
                        // Play subtle sound
                        playRecoverySound();
                        
                        setTimeout(() => {
                            timerDisplay.style.display = 'none';
                        }, 3000);
                        
                        // Clear recovery state
                        const savedState = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                        delete savedState[exerciseId].recoveryEndTime;
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedState));
                    }
                    timeLeft--;
                }, 1000);
            }
            
            // Restore previous interactive elements and logic
            // [Rest of the previous createSeriesTracker function remains the same]
            
            // Modify existing event listeners to include state saving
            addButton.addEventListener('click', () => {
                if (currentSeries < maxSeries) {
                    currentSeries++;
                    counterDisplay.textContent = `Serie: ${currentSeries}/${maxSeries}`;
                    
                    if (currentSeries < maxSeries) {
                        startRecoveryTimer(recoveryTime);
                    }
                }
                
                if (currentSeries === maxSeries) {
                    addButton.disabled = true;
                }
                
                saveState();
            });
            
            resetButton.addEventListener('click', () => {
                currentSeries = 0;
                counterDisplay.textContent = `Serie: ${currentSeries}/${maxSeries}`;
                addButton.disabled = false;
                timerDisplay.style.display = 'none';
                timerDisplay.classList.remove('active-timer');
                if (timerInterval) clearInterval(timerInterval);
                if (workoutTimer) clearInterval(workoutTimer);
                isRecoveryActive = false;
                
                // Clear saved state for this exercise
                const savedState = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                delete savedState[exerciseId];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(savedState));
            });
            
            // [Rest of the function remains the same]
        }
        
        // Existing helper functions remain unchanged
        
        // Persist total workout time across page reloads
        let workoutStartTime = localStorage.getItem('workoutStartTime');
        if (!workoutStartTime) {
            workoutStartTime = Date.now();
            localStorage.setItem('workoutStartTime', workoutStartTime);
        }
        
        // Optional: Display total workout time
        function updateTotalWorkoutTime() {
            const elapsedTime = Math.floor((Date.now() - parseInt(workoutStartTime)) / 1000);
            const hours = Math.floor(elapsedTime / 3600);
            const minutes = Math.floor((elapsedTime % 3600) / 60);
            const seconds = elapsedTime % 60;
            
            const totalTimeDisplay = document.createElement('div');
            totalTimeDisplay.id = 'total-workout-time';
            totalTimeDisplay.style.position = 'fixed';
            totalTimeDisplay.style.bottom = '10px';
            totalTimeDisplay.style.right = '10px';
            totalTimeDisplay.style.background = 'rgba(0,0,0,0.7)';
            totalTimeDisplay.style.color = 'white';
            totalTimeDisplay.style.padding = '10px';
            totalTimeDisplay.style.borderRadius = '5px';
            totalTimeDisplay.textContent = `Tempo totale: ${hours}h ${minutes}m ${seconds}s`;
            
            document.body.appendChild(totalTimeDisplay);
        }
        
        // Add listeners and initialize
        document.addEventListener('DOMContentLoaded', () => {
            const exerciseCards = document.querySelectorAll('.exercise-card');
            exerciseCards.forEach(card => {
                const seriesText = card.querySelector('p')?.textContent;
                if (seriesText) {
                    const maxSeries = parseInt(seriesText);
                    if (!isNaN(maxSeries)) {
                        createSeriesTracker(card, maxSeries);
                    }
                }
            });
            
            updateTotalWorkoutTime();
            
            // Update total workout time every second
            setInterval(updateTotalWorkoutTime, 1000);
        });
    </script>
</body>
</html>
