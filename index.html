// Aggiungi queste funzioni all'inizio dello script

// Salvataggio dei dati nel localStorage
function saveProgress() {
    const exerciseCards = document.querySelectorAll('.exercise-card');
    const progressData = Array.from(exerciseCards).map(card => {
        const counterDisplay = card.querySelector('.counter-display');
        return {
            exercise: card.querySelector('h3').textContent,
            currentSeries: parseInt(counterDisplay.textContent.split('/')[0].split(':')[1])
        };
    });
    localStorage.setItem('workoutProgress', JSON.stringify(progressData));
    localStorage.setItem('lastProgressTime', Date.now());
}

// Caricamento dei dati dal localStorage
function loadProgress() {
    const progressData = JSON.parse(localStorage.getItem('workoutProgress'));
    const lastProgressTime = localStorage.getItem('lastProgressTime');
    
    if (progressData) {
        const exerciseCards = document.querySelectorAll('.exercise-card');
        exerciseCards.forEach(card => {
            const savedExercise = progressData.find(p => p.exercise === card.querySelector('h3').textContent);
            if (savedExercise) {
                const counterDisplay = card.querySelector('.counter-display');
                const maxSeries = parseInt(counterDisplay.textContent.split('/')[1]);
                const currentSeries = savedExercise.currentSeries;
                
                counterDisplay.textContent = `Serie: ${currentSeries}/${maxSeries}`;
                
                const addButton = card.querySelector('button:not(.reset-button)');
                if (currentSeries >= maxSeries) {
                    addButton.disabled = true;
                }
            }
        });
    }
}

// Suono di allarme
function playAlarm() {
    const audio = new Audio('data:audio/wav;base64,UklGRhQCAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhEAIAAPD/8P/w//D/8P/w//D/');
    audio.play();
}

// Modifica la funzione createSeriesTracker per aggiungere il recupero dopo 4/4
function createSeriesTracker(exerciseCard, maxSeries) {
    // ... (codice esistente) ...

    // Modifica l'evento del bottone "addButton"
    addButton.addEventListener('click', () => {
        if (currentSeries < maxSeries) {
            currentSeries++;
            counterDisplay.textContent = `Serie: ${currentSeries}/${maxSeries}`;
            
            if (currentSeries < maxSeries) {
                startRecoveryTimer(recoveryTime);
            } else if (currentSeries === maxSeries) {
                // Avvia il recupero finale
                startRecoveryTimer(recoveryTime * 2); // Doppio tempo di recupero
                playAlarm(); // Suona l'allarme
            }
            
            saveProgress(); // Salva i progressi
        }
        
        if (currentSeries === maxSeries) {
            addButton.disabled = true;
        }
    });

    // Aggiungi salvataggio al reset
    resetButton.addEventListener('click', () => {
        // ... (codice esistente) ...
        saveProgress(); // Salva i progressi dopo il reset
    });

    return counterDiv;
}

// Carica i progressi quando la pagina si carica
document.addEventListener('DOMContentLoaded', () => {
    const exerciseCards = document.querySelectorAll('.exercise-card');
    exerciseCards.forEach(card => {
        const seriesText = card.querySelector('p')?.textContent;
        if (seriesText) {
            const maxSeries = parseInt(seriesText);
            if (!isNaN(maxSeries)) {
                createSeriesTracker(card, maxSeries);
            }
        }
    });

    loadProgress(); // Carica i progressi salvati
});

// Salva i progressi prima che la pagina venga chiusa
window.addEventListener('beforeunload', saveProgress);
